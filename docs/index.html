<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentryInsight Exploitation Report</title>
    <link rel="icon" type="image/png" href="/SentryInsight/assets/logo.png">
    <link rel="shortcut icon" type="image/png" href="/SentryInsight/assets/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">
    <style>
        :root {
            --primary-red: #dc2626;
            --warning-orange: #ea580c;
            --success-green: #16a34a;
            --info-blue: #2563eb;
            --dark-bg: #0b1220;
            --dark-elev: #111827;
            --light-bg: #f8fafc;
            --border-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --muted: #94a3b8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            margin: 0 auto;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        @media (max-width: 767px) {
            body {
                padding: 0;
            }
        }

        /* App frame */
        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header.topbar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(248, 250, 252, 0.8);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid var(--border-color);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }
        .brand img { width: 28px; height: 28px; border-radius: 6px; }
        .brand .title { color: var(--text-primary); }
        .brand .subtitle { color: var(--muted); font-weight: 500; font-size: 0.9rem; }

        .spacer { flex: 1; }

        .toolbar { display: flex; gap: 8px; align-items: center; }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border-color);
            background: #ffffff;
            color: var(--text-primary);
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn:hover { box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .btn.primary { background: var(--primary-red); color: #fff; border-color: #b91c1c; }
        .btn.ghost { background: transparent; }

        /* compact toolbar (only theme toggle now) */

        .layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 20px;
            align-items: start;
            margin-top: 16px;
        }
        @media (max-width: 960px) {
            .layout { grid-template-columns: 1fr; }
            aside#toc { position: static; }
        }

        aside#toc {
            position: sticky;
            top: 68px;
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            max-height: calc(100vh - 100px);
            overflow: auto;
        }
        aside#toc.hidden { display: none; }
        #toc h4 { margin: 6px 8px 8px; color: var(--text-secondary); }
        #toc a { color: var(--text-secondary); text-decoration: none; display: block; padding: 4px 8px; border-radius: 6px; }
        #toc a:hover { background: #f1f5f9; color: var(--text-primary); }
        #toc .lvl-2 { font-weight: 600; }
        #toc .lvl-3 { padding-left: 16px; font-size: 0.95rem; }

        #content {
            background: white;
            padding: 2.0em;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        /* Header styling */
        .markdown-body h1 {
            background: linear-gradient(135deg, var(--primary-red), #b91c1c);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 8px;
            margin: -1rem -1rem 2rem -1rem;
            border-left: 6px solid #991b1b;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        }

        .markdown-body h2 {
            color: var(--primary-red);
            border-bottom: 3px solid var(--primary-red);
            padding-bottom: 0.5rem;
            margin-top: 2.5rem;
            position: relative;
        }

        .markdown-body h2 { scroll-margin-top: 80px; }

        .markdown-body h3 {
            color: var(--warning-orange);
            background: rgba(234, 88, 12, 0.1);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            border-left: 4px solid var(--warning-orange);
            margin-top: 1.5rem;
            scroll-margin-top: 80px;
            cursor: pointer;
        }

        .section-collapsible .section-body { display: none; }
        .section-collapsible.open .section-body { display: block; }
        .section-collapsible .toggle { float: right; color: var(--muted); font-weight: 600; font-size: 0.85rem; }

        .heading-anchor {
            opacity: 0;
            margin-left: 6px;
            text-decoration: none;
            color: #94a3b8;
            font-weight: 600;
        }
        .markdown-body h2:hover .heading-anchor,
        .markdown-body h3:hover .heading-anchor { opacity: 1; }

        .meta {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: -12px;
            margin-bottom: 16px;
        }

        /* Severity badges */
        .severity-critical {
            background: var(--primary-red);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }

        .severity-high {
            background: var(--warning-orange);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }

        .severity-medium {
            background: #fbbf24;
            color: #92400e;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }

        /* Enhanced list styling */
        .markdown-body ul li {
            margin: 0.75rem 0;
            padding-left: 0.5rem;
            border-left: 3px solid var(--border-color);
            color: var(--text-primary);
        }

        .markdown-body ul li strong {
            color: var(--primary-red);
        }

        /* Detail blocks added via JS */
        .detail-block {
            background: #ffffff;
            padding: 0.75rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            border-left: 4px solid var(--info-blue);
        }
        .threat-actor {
            background: rgba(220, 38, 38, 0.06);
            border-left: 4px solid var(--primary-red);
        }

        /* Ensure all text is readable */
        .markdown-body p, .markdown-body li {
            color: var(--text-primary);
        }
        .markdown-body a { color: var(--info-blue); text-decoration: underline; }
        body.dark .markdown-body a { color: #93c5fd; }
        .markdown-body code, .markdown-body pre { background: #f1f5f9; border: 1px solid var(--border-color); border-radius: 6px; }
        body.dark .markdown-body code, body.dark .markdown-body pre { background: #0b1220; color: #e5e7eb; border-color: #1f2937; }

        /* Executive Summary */
        .exec { border: 1px solid var(--border-color); background: #ffffff; border-radius: 12px; padding: 12px 16px; margin: 8px 0 16px; }
        .exec h4 { margin: 0 0 6px; color: var(--text-secondary); }
        .exec p { margin: 0; color: var(--text-primary); }
        body.dark .exec { background: var(--dark-elev); border-color: #1f2937; }
        body.dark .exec h4 { color: #cbd5e1; }
        body.dark .exec p { color: #e5e7eb; }

        /* Add loading animation */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .loading:after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-red);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dark mode */
        body.dark { background: linear-gradient(135deg, #0b1220 0%, #0f172a 100%);
            --text-primary: #e5e7eb;
            --text-secondary: #cbd5e1;
            --border-color: #1f2937;
        }
        body.dark header.topbar { background: rgba(15, 23, 42, 0.7); border-bottom-color: #1f2937; }
        body.dark #content, body.dark aside#toc { background: var(--dark-elev); border-color: #1f2937; }
        body.dark .btn { background: #111827; color: #e5e7eb; border-color: #1f2937; }
        body.dark .btn.primary { background: #b91c1c; border-color: #7f1d1d; }
        body.dark #toc a:hover { background: #0b1220; }
        body.dark .markdown-body { color: #e5e7eb; }
        body.dark .markdown-body h2 { color: #fca5a5; border-bottom-color: #7f1d1d; }
        body.dark .markdown-body h3 { color: #fb923c; background: rgba(251, 146, 60, 0.08); }
        body.dark .detail-block { background: #0b1220; }
    </style>
    <style>
        /* Additions: summary, status badges, toast, print */
        .summary { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; margin: 8px 0 16px; }
        .card { border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: #fff; }
        .card h5 { margin: 0 0 6px; color: var(--text-secondary); font-weight: 600; font-size: 0.9rem; }
        .card .value { font-size: 1.4rem; font-weight: 700; color: var(--text-primary); }
        .chips { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
        .chip { border: 1px solid var(--border-color); background: #fafafa; border-radius: 999px; padding: 2px 8px; font-size: 0.82rem; }
        .status-badge { margin-left: 6px; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; color: #fff; }
        .status-active { background: #dc2626; }
        .status-patched { background: #16a34a; }
        .status-monitor { background: #2563eb; }
        .toast { position: fixed; right: 16px; bottom: 16px; background: #111827; color: #fff; padding: 10px 12px; border-radius: 8px; opacity: 0; transform: translateY(8px); transition: all .2s ease; z-index: 100; }
        .toast.show { opacity: 1; transform: translateY(0); }
        @media (max-width: 767px) { .summary { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        /* Sidebar summary layout */
        aside .summary { grid-template-columns: 1fr; margin-top: 12px; }
        /* TOC active */
        #toc a.active { background: #e2e8f0; color: var(--text-primary); font-weight: 600; }
        body.dark #toc a.active { background: #0b1220; }
        @media print {
            header.topbar, aside#toc { display: none !important; }
            body { background: #fff !important; }
            .app { padding: 0; }
            #content { box-shadow: none; border: none; }
            h1 { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            h2 { page-break-before: avoid; }
            .section-collapsible .section-body { display: block !important; }
            .section-collapsible { break-inside: avoid; page-break-inside: avoid; }
        }
        body.dark .card { background: #111827; border-color: #1f2937; }
        body.dark .chip { background: #0b1220; border-color: #1f2937; color: #cbd5e1; }
        .chip.chip-critical { background: #fee2e2; border-color: #fecaca; color: #991b1b; }
        .chip.chip-patch { background: #dcfce7; border-color: #bbf7d0; color: #166534; }
    </style>
</head>
<body>
    <div class="app">
        <header class="topbar">
            <div class="brand">
                <img src="/SentryInsight/assets/logo.png" alt="SentryInsight" />
                <div>
                    <div class="title">SentryInsight</div>
                    <div class="subtitle">Exploitation Intelligence Report</div>
                </div>
            </div>
            <div class="spacer"></div>
            <div class="toolbar">
                <button id="toggle-dark" class="btn" title="Toggle theme">Theme</button>
            </div>
        </header>

        <div class="layout">
            <aside id="toc">
                <h4>On this page</h4>
                <nav id="toc-list"></nav>
                <div id="summary" class="summary"></div>
            </aside>
            <main>
                <div class="meta" id="meta"></div>
                <div id="exec" class="exec"></div>
                <div id="content" class="markdown-body"></div>
            </main>
        </div>
    </div>

    <script>
        const contentEl = document.getElementById('content');
        const tocEl = document.getElementById('toc-list');
        const metaEl = document.getElementById('meta');
        const summaryEl = document.getElementById('summary');
        const toggleDarkEl = document.getElementById('toggle-dark');
        const execEl = document.getElementById('exec');

        // Initial UI state
        contentEl.innerHTML = '<div class="loading">Loading exploitation report...</div>';
        const preferDark = localStorage.getItem('sentryinsight:theme') === 'dark' || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (preferDark) document.body.classList.add('dark');

        // Optional UI config for easier customization
        let UI_CONF = null;
        const configPromise = fetch('config/ui.json').then(r => r.ok ? r.json() : null).then(j => { UI_CONF = j; }).catch(() => null);

        function slugify(text) {
            return text.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').substring(0, 80);
        }

        function addHeadingAnchors() {
            const headings = contentEl.querySelectorAll('h2, h3');
            headings.forEach(h => {
                if (!h.id) h.id = slugify(h.textContent);
                const a = document.createElement('a');
                a.href = `#${h.id}`;
                a.className = 'heading-anchor';
                a.textContent = '#';
                h.appendChild(a);
            });
        }

        function buildTOC() {
            tocEl.innerHTML = '';
            const frag = document.createDocumentFragment();
            contentEl.querySelectorAll('h2, h3').forEach(h => {
                const a = document.createElement('a');
                a.href = `#${h.id}`;
                a.textContent = h.textContent.replace(/#/g, '').trim();
                a.className = h.tagName === 'H2' ? 'lvl-2' : 'lvl-3';
                frag.appendChild(a);
            });
            tocEl.appendChild(frag);
            // Smooth scroll
            tocEl.querySelectorAll('a').forEach(a => {
                a.addEventListener('click', (e) => {
                    const href = a.getAttribute('href');
                    const target = contentEl.querySelector(href);
                    if (target) { e.preventDefault(); target.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
                });
            });
            // Scroll spy active state
            const map = new Map();
            tocEl.querySelectorAll('a').forEach(a => map.set(a.getAttribute('href')?.slice(1), a));
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    const id = entry.target.id;
                    const link = map.get(id);
                    if (!link) return;
                    tocEl.querySelectorAll('a').forEach(x => x.classList.remove('active'));
                    link.classList.add('active');
                });
            }, { rootMargin: '0px 0px -70% 0px', threshold: 0.1 });
            contentEl.querySelectorAll('h3').forEach(h => observer.observe(h));
        }

        function classifyDetailBlocks() {
            contentEl.querySelectorAll('li').forEach(li => {
                const strong = li.querySelector('strong');
                if (!strong) return;
                const label = strong.textContent.trim().toLowerCase();
                if (['description', 'impact', 'status', 'mitigation', 'references', 'cve id', 'cve'].some(k => label.startsWith(k))) {
                    li.classList.add('detail-block');
                }
                if (label.includes('threat actor')) li.classList.add('threat-actor');
            });
        }

        function addSeverityBadges() {
            // Headings heuristics
            contentEl.querySelectorAll('h3').forEach(h3 => {
                const text = h3.textContent.toLowerCase();
                const sev = UI_CONF && UI_CONF.severity;
                const reCrit = sev ? new RegExp(`(${(sev.critical||[]).join('|')})`, 'i') : /(critical|rce|remote code|0day|0-day|zero-day)/i;
                const reHigh = sev ? new RegExp(`(${(sev.high||[]).join('|')})`, 'i') : /(phishing|supply chain|banking trojan|android malware|lpe|privilege escalation)/i;
                const reMed  = sev ? new RegExp(`(${(sev.medium||[]).join('|')})`, 'i') : /(cryptojacking|docker|misconfig|bruteforce)/i;
                if (reCrit.test(text)) {
                    const b = document.createElement('span'); b.className = 'severity-critical'; b.textContent = 'Critical'; h3.appendChild(document.createTextNode(' ')); h3.appendChild(b);
                } else if (reHigh.test(text)) {
                    const b = document.createElement('span'); b.className = 'severity-high'; b.textContent = 'High'; h3.appendChild(document.createTextNode(' ')); h3.appendChild(b);
                } else if (reMed.test(text)) {
                    const b = document.createElement('span'); b.className = 'severity-medium'; b.textContent = 'Medium'; h3.appendChild(document.createTextNode(' ')); h3.appendChild(b);
                }
                const m = h3.textContent.match(/(CVE-\d{4}-\d{4,7})/i);
                if (m) {
                    const a = document.createElement('a'); a.href = `https://nvd.nist.gov/vuln/detail/${m[1]}`; a.target = '_blank'; a.rel = 'noopener';
                    const chip = document.createElement('span'); chip.className = 'chip'; chip.textContent = m[1];
                    a.appendChild(chip);
                    h3.appendChild(document.createTextNode(' '));
                    h3.appendChild(a);
                }
            });
        }

        // Enhance tags within the Active Exploitation Details section
        function enhanceActiveExploitationTags() {
            const activeH2 = Array.from(contentEl.querySelectorAll('h2')).find(h => /active exploitation details/i.test(h.textContent));
            if (!activeH2) return;
            let el = activeH2.nextElementSibling;
            while (el && el.tagName !== 'H2') {
                if (el.classList && el.classList.contains('section-collapsible')) {
                    const h3 = el.querySelector('h3');
                    const body = el.querySelector('.section-body') || el;
                    const text = body.textContent.toLowerCase();
                    // Add Critical badge/chip if description mentions critical
                    const hasCritBadge = h3.querySelector('.severity-critical');
                    if (/\bcritical\b/.test(text) && !hasCritBadge) {
                        const b = document.createElement('span'); b.className = 'severity-critical'; b.textContent = 'Critical';
                        h3.appendChild(document.createTextNode(' '));
                        h3.appendChild(b);
                        const c = document.createElement('span'); c.className = 'chip chip-critical'; c.textContent = 'Critical';
                        h3.appendChild(document.createTextNode(' '));
                        h3.appendChild(c);
                    }
                    // Add Patch chip if status/description suggests updates/patching
                    const hasPatch = Array.from(h3.querySelectorAll('.chip')).some(ch => /patch/i.test(ch.textContent));
                    if (/(patch|patched|update|updated|fix|fixed|security update)/i.test(text) && !hasPatch) {
                        const p = document.createElement('span'); p.className = 'chip chip-patch'; p.textContent = 'Patch';
                        h3.appendChild(document.createTextNode(' '));
                        h3.appendChild(p);
                    }
                }
                el = el.nextElementSibling;
            }
        }

        function linkifyCVEs() {
            const re = /CVE-\d{4}-\d{4,7}/g;
            contentEl.querySelectorAll('p, li').forEach(el => {
                el.innerHTML = el.innerHTML.replace(re, (m) => `<a href="https://nvd.nist.gov/vuln/detail/${m}" target="_blank" rel="noopener">${m}</a>`);
            });
        }

        // Load actors mapping generated during publish (actors.json)
        let ACTORS_MAP = {};
        function loadActors() {
            return fetch('actors.json?v=' + Date.now())
              .then(r => r.ok ? r.json() : {})
              .then(j => { ACTORS_MAP = j || {}; })
              .catch(() => { ACTORS_MAP = {}; });
        }

        // Load malware mapping generated during publish (malware.json)
        let MALWARE_MAP = {};
        function loadMalware() {
            return fetch('malware.json?v=' + Date.now())
              .then(r => r.ok ? r.json() : {})
              .then(j => { MALWARE_MAP = j || {}; })
              .catch(() => { MALWARE_MAP = {}; });
        }

        function escapeRegex(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

        function deriveActorsFromMarkdown(md) {
            const result = {};
            if (!md) return result;
            // Focus on Threat Actor Activities section if present
            const secRe = /^##\s+Threat Actor Activities\s*$/im;
            let secText = md;
            const m = md.match(secRe);
            if (m) {
                const start = m.index + m[0].length;
                const rest = md.slice(start);
                const nextH2 = rest.search(/^##\s+/m);
                secText = nextH2 >= 0 ? rest.slice(0, nextH2) : rest;
            }
            const names = new Set();
            const drop = /(unattributed|cluster|clusters|campaigns?)/i;
            // Bold list item names
            const boldRe = /^-\s*\*\*([^*]+)\*\*/gm;
            let mb;
            while ((mb = boldRe.exec(secText)) !== null) {
                let raw = mb[1].trim();
                raw = raw.replace(/\s*\(.*\)$/, '').trim();
                raw.split(/\s*&\s*/).forEach(p => {
                    const name = p.trim();
                    if (!name || drop.test(name)) return;
                    names.add(name);
                });
            }
            // Code names in quotes
            const quoteRe = /["“”']([A-Z][A-Za-z0-9][A-Za-z0-9\-\s]{1,40})["“”']/g;
            let mq;
            while ((mq = quoteRe.exec(secText)) !== null) {
                const name = mq[1].trim();
                if (!drop.test(name)) names.add(name);
            }
            // Common prefixes
            const tagRe = /\b(?:APT|TA|UNC|FIN)[ -]?\d{1,4}\b/gi;
            let mt;
            while ((mt = tagRe.exec(secText)) !== null) {
                const norm = mt[0].toUpperCase().replace(/\s|-/, '');
                if (!drop.test(norm)) names.add(norm);
            }
            const drops = /^(HTTP|HTTPS|TLS|SSL|VPN|DNS|ASA|IOS|IIS|SSH|RDP|SFTP|FTP|SMTP|SQL|XML|JSON|RANSOMWARE|TROJAN|BACKDOOR|BACKDOORS|DOWNLOADER|CAMPAIGN|OPERATIONS|ACCESS|AFFILIATE)$/i;
            Array.from(names).forEach(n => {
                if (/^(APT|TA|UNC|FIN)\d+$/i.test(n)) return;
                if ((n.toUpperCase() === n && n.length <= 3) || drops.test(n)) return;
                const q = encodeURIComponent('"' + n + '"');
                result[n] = `https://www.virustotal.com/gui/search/${q}`;
            });
            return result;
        }

        function deriveMalwareFromMarkdown(md) {
            const result = {};
            if (!md) return result;
            const names = new Set();
            // If lines follow "ACTOR: ...", pick ALL-CAPS tokens from RHS
            const secMatch = md.match(/^##\s+Threat Actor Activities\s*$/im);
            let scope = md;
            if (secMatch) {
                const start = secMatch.index + secMatch[0].length;
                const rest = md.slice(start);
                const nextH2 = rest.search(/^##\s+/m);
                scope = nextH2 >= 0 ? rest.slice(0, nextH2) : rest;
            }
            scope.split(/\n+/).forEach(line => {
                const idx = line.indexOf(':');
                if (idx <= 0) return;
                const lhs = line.slice(0, idx).trim();
                if (!/^(APT|TA|UNC|FIN)\d+$/i.test(lhs)) return;
                const rhs = line.slice(idx+1);
                const reCaps = /\b([A-Z][A-Z0-9._-]{3,})\b/g;
                let m;
                while ((m = reCaps.exec(rhs)) !== null) {
                    const tok = m[1];
                    if (/^(IOC|IETF|HTTP|HTTPS|TLS|SSL|VPN|DNS|AAD|MFA|SQL)$/.test(tok)) continue;
                    names.add(tok);
                }
            });
            const quoteRe = /["“”']([A-Z][A-Za-z0-9][A-Za-z0-9\-]{1,40})["“”']/g;
            let mq;
            while ((mq = quoteRe.exec(md)) !== null) names.add(mq[1].trim());
            const suf = /(Bot|Loader|RAT|Stealer|Worm|Backdoor|Trojan|Spy|Spyware|Banker|Locker|Ransom|Ransomware)\b/i;
            const wordRe = /\b([A-Z][A-Za-z0-9]*(?:[A-Z][A-Za-z0-9]+)*[A-Za-z0-9]{2,})\b/g;
            let mw;
            while ((mw = wordRe.exec(md)) !== null) {
                const w = mw[0];
                if (suf.test(w)) names.add(w);
            }
            Array.from(names).forEach(n => {
                const q = encodeURIComponent('"' + n + '"');
                result[n] = `https://www.virustotal.com/gui/search/${q}`;
            });
            return result;
        }

        function linkifyThreatActors() {
            const names = Object.keys(ACTORS_MAP || {});
            if (!names.length) return;
            // Sort by length to avoid partial matches (e.g., APT2 vs APT29)
            names.sort((a,b) => b.length - a.length);
            const re = new RegExp('\\b(' + names.map(escapeRegex).join('|') + ')\\b', 'g');
            contentEl.querySelectorAll('p, li').forEach(el => {
                el.innerHTML = el.innerHTML.replace(re, (m) => {
                    const url = ACTORS_MAP[m] || `https://www.virustotal.com/gui/search/${encodeURIComponent('"' + m + '"')}`;
                    return `<a href="${url}" target="_blank" rel="noopener">${m}</a>`;
                });
            });
        }

        function linkifyMalware() {
            const names = Object.keys(MALWARE_MAP || {});
            if (!names.length) return;
            names.sort((a,b) => b.length - a.length);
            const re = new RegExp('\\b(' + names.map(escapeRegex).join('|') + ')\\b', 'g');
            contentEl.querySelectorAll('p, li').forEach(el => {
                el.innerHTML = el.innerHTML.replace(re, (m) => {
                    const url = MALWARE_MAP[m] || `https://www.virustotal.com/gui/search/${encodeURIComponent('"' + m + '"')}`;
                    return `<a href="${url}" target="_blank" rel="noopener">${m}</a>`;
                });
            });
        }

        function addStatusBadges() {
            contentEl.querySelectorAll('.section-collapsible').forEach(sec => {
                const h3 = sec.querySelector('h3');
                if (!h3) return;
                let statusText = '';
                sec.querySelectorAll('li').forEach(li => {
                    const s = li.querySelector('strong');
                    if (!s) return;
                    const key = s.textContent.trim().toLowerCase();
                    if (key.startsWith('status')) statusText = li.textContent.toLowerCase();
                });
                if (!statusText) return;
                let cls = '', label = '';
                const st = UI_CONF && UI_CONF.status;
                const reActive = st ? new RegExp(`(${(st.active||[]).join('|')})`, 'i') : /active|exploited|in the wild/i;
                const rePatched = st ? new RegExp(`(${(st.patched||[]).join('|')})`, 'i') : /patched|fixed|updates released/i;
                if (reActive.test(statusText)) { cls = 'status-active'; label = 'Active'; }
                else if (rePatched.test(statusText)) { cls = 'status-patched'; label = 'Patched'; }
                else { cls = 'status-monitor'; label = 'Monitor'; }
                const b = document.createElement('span'); b.className = `status-badge ${cls}`; b.textContent = label; h3.appendChild(document.createTextNode(' ')); h3.appendChild(b);
            });
        }

        function makeCollapsible() {
            // Wrap sections such that each h3 controls its following siblings until next h3/h2
            const nodes = Array.from(contentEl.children);
            for (let i = 0; i < nodes.length; i++) {
                const n = nodes[i];
                if (n.tagName === 'H3') {
                    const wrap = document.createElement('div');
                    wrap.className = 'section-collapsible open';
                    const toggle = document.createElement('span');
                    toggle.className = 'toggle';
                    toggle.textContent = '▼';
                    n.appendChild(toggle);
                    const body = document.createElement('div');
                    body.className = 'section-body';
                    // Move following siblings into body until next H3 or H2
                    let j = i + 1;
                    while (j < nodes.length && !['H3','H2'].includes(nodes[j].tagName)) {
                        body.appendChild(nodes[j]);
                        nodes.splice(j, 1);
                    }
                    n.after(wrap);
                    wrap.appendChild(n);
                    wrap.appendChild(body);
                }
            }
            contentEl.addEventListener('click', (e) => {
                const h3 = e.target.closest('h3');
                if (!h3) return;
                const container = h3.parentElement;
                if (!container.classList.contains('section-collapsible')) return;
                container.classList.toggle('open');
                const t = h3.querySelector('.toggle');
                if (t) t.textContent = container.classList.contains('open') ? '▼' : '▶';
            });
        }

        function setMeta(dateStr) {
            const d = new Date();
            const now = d.toLocaleString();
            metaEl.textContent = `Last updated: ${dateStr || now}`;
        }

        function computeSummary() {
            // Cards intentionally removed per request
            summaryEl.innerHTML = ``;
        }

        function wireShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.target && ['input','textarea'].includes((e.target.tagName||'').toLowerCase())) return;
                const k = e.key.toLowerCase();
                if (k === 't') { toggleDarkEl.click(); }
            });
        }

        function download(filename, content, type='text/plain') {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        // Fetch and render the markdown content (after UI config)
        let markdownCache = '';
        Promise.all([configPromise])
          .then(() => fetch('index.md?v=' + Date.now(), { cache: 'no-store' }))
          .then(response => response.text())
          .then(text => {
                markdownCache = text;
                let html = marked.parse(text);
                contentEl.innerHTML = html;

                // Extract executive summary (first paragraph after H1)
                execEl.innerHTML = '';
                const h1 = contentEl.querySelector('h1');
                if (h1) {
                    let next = h1.nextElementSibling;
                    if (next && next.tagName === 'P') {
                        execEl.innerHTML = `<h4>Executive Summary</h4>`;
                        execEl.appendChild(next.cloneNode(true));
                        next.remove();
                    }
                }

                // Post-processing
                addHeadingAnchors();
                addSeverityBadges();
                classifyDetailBlocks();
                linkifyCVEs();
                makeCollapsible();
                addStatusBadges();
                enhanceActiveExploitationTags();
                buildTOC();
                // Load actors and malware, merge with derived sets, linkify and compute summary
                Promise.all([loadActors(), loadMalware()]).then(() => {
                    const derivedActors = deriveActorsFromMarkdown(markdownCache);
                    ACTORS_MAP = Object.assign({}, derivedActors, ACTORS_MAP || {});
                    const derivedMal = deriveMalwareFromMarkdown(markdownCache);
                    MALWARE_MAP = Object.assign({}, derivedMal, MALWARE_MAP || {});
                    linkifyThreatActors();
                    linkifyMalware();
                    computeSummary();
                });
                const m = text.match(/title:\s*Exploitation Intelligence Report\s*-\s*(\d{4}-\d{2}-\d{2})/i);
                setMeta(m ? m[1] : '');
          })
            .catch(error => {
                contentEl.innerHTML = `
                    <h1>Error Loading Report</h1>
                    <p>Unable to load the exploitation report. Please check back later.</p>
                    <pre>${error}</pre>
                `;
            });

        // Controls
        toggleDarkEl.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const mode = document.body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('sentryinsight:theme', mode);
        });
        wireShortcuts();

        // Copy heading link via anchor click
        contentEl.addEventListener('click', (e) => {
            const a = e.target.closest('a.heading-anchor');
            if (!a) return;
            e.preventDefault();
            const url = `${location.origin}${location.pathname}${a.getAttribute('href')}`;
            navigator.clipboard.writeText(url).then(() => showToast('Link copied to clipboard'));
        });

        // Expand for print
        window.addEventListener('beforeprint', () => {
            contentEl.querySelectorAll('.section-collapsible').forEach(c => c.classList.add('open'));
        });

        // Toast helper
        const toast = document.createElement('div'); toast.className = 'toast'; document.body.appendChild(toast);
        function showToast(msg) { toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 1500); }
    </script>
</body>
</html>
